const { Telegraf, Markup } = require('telegraf');
const axios = require('axios');
const { SocksProxyAgent } = require('socks-proxy-agent');

// Configura√ß√µes
const torProxy = 'socks5h://127.0.0.1:9050';
const agent = new SocksProxyAgent(torProxy);
const bot = new Telegraf('7876916554:AAG1cvnHL6rVEM9Uph08RtlWVy1ZGsFwQxU');

// Delay entre comandos (mantido para evitar flooding da API do Telegram)
bot.use((ctx, next) => setTimeout(() => next(), 2000));

// ====== ESTRUTURA DOS MENUS ====== //
const criarMenuPrincipal = () => Markup.inlineKeyboard([
    [Markup.button.callback('üìú COMANDOS', 'comandos')],
    [Markup.button.callback('üë§ MINHAS INFOS', 'userinfo')], // Nome do bot√£o alterado
    [Markup.button.callback('üåü CR√âDITOS', 'creditos')]
]);

const criarMenuVoltar = () => Markup.inlineKeyboard([
    [Markup.button.callback('üîô VOLTAR AO MENU', 'voltar_menu')] // Nome do bot√£o alterado
]);

// ====== COMANDO /MENU ====== //
bot.command('menu', (ctx) => {
    ctx.replyWithMarkdown(
        '‚ú® *BEM-VINDO AO PAINEL DE CONSULTAS!* ‚ú®\n\n_Selecione uma op√ß√£o abaixo para come√ßar:_',
        criarMenuPrincipal()
    );
});

// ====== A√á√ïES DOS BOT√ïES DE MENU ====== //

bot.action('voltar_menu', async (ctx) => {
    try {
        await ctx.editMessageText(
            '‚ú® *BEM-VINDO AO PAINEL DE CONSULTAS!* ‚ú®\n\n_Selecione uma op√ß√£o abaixo para come√ßar:_',
            {
                parse_mode: 'Markdown',
                ...criarMenuPrincipal()
            }
        );
    } catch (error) {
        // Fallback caso a mensagem original n√£o possa ser editada (ex: muito antiga)
        await ctx.replyWithMarkdown(
            '‚ú® *BEM-VINDO AO PAINEL DE CONSULTAS!* ‚ú®\n\n_Selecione uma op√ß√£o abaixo para come√ßar:_',
            criarMenuPrincipal()
        );
    }
    await ctx.answerCbQuery(); // Esconde o rel√≥gio de carregamento do bot√£o
});

bot.action('comandos', async (ctx) => {
    try {
        await ctx.editMessageText(`
üìú *COMANDOS DISPON√çVEIS* üìú

Aqui voc√™ encontra a lista de todas as consultas que posso fazer para voc√™!

üîç *Consultas:*
‚îú \`/cpf [n√∫mero]\` - Consulta CPF (Nome, G√™nero, Nascimento, Renda, Nome da M√£e)
‚îú \`/cep [n√∫mero]\` - Consulta CEP (Endere√ßo completo)
‚îú \`/ip [endere√ßo]\` - Geolocaliza√ß√£o de IP
‚îú \`/ddd [n√∫mero]\` - Consulta de DDD (Cidades e Estado)
‚îî \`/bin [6 d√≠gitos]\` - Consulta de BIN (Dados do Cart√£o)

‚öôÔ∏è *Utilit√°rios:*
‚îú \`/menu\` - Exibe este painel de navega√ß√£o
‚îî \`/tor\` - Comando futuro para rota√ß√£o de IP via Tor (ainda n√£o implementado)
        `, {
            parse_mode: 'Markdown',
            ...criarMenuVoltar()
        });
    } catch (error) {
        await ctx.replyWithMarkdown(
            'üìú *COMANDOS DISPON√çVEIS* üìú\n(Use /menu para navegar e ver o painel completo)',
            criarMenuVoltar()
        );
    }
    await ctx.answerCbQuery();
});

bot.action('userinfo', async (ctx) => {
    const user = ctx.from;
    const userId = user.id;
    const userName = user.username ? `@${user.username}` : 'N/A';
    const firstName = user.first_name || 'N/A';
    const lastName = user.last_name || 'N/A';
    const isBot = user.is_bot ? 'Sim' : 'N√£o';
    const languageCode = user.language_code || 'N/A';

    try {
        await ctx.editMessageText(`
üë§ *SUAS INFORMA√á√ïES DO TELEGRAM* üë§
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *ID do Usu√°rio:* \`${userId}\`
‚îÇ *Username:* ${userName}
‚îÇ *Primeiro Nome:* ${firstName}
‚îÇ *Sobrenome:* ${lastName}
‚îÇ *√â um Bot?* ${isBot}
‚îÇ *Idioma:* ${languageCode}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, {
            parse_mode: 'Markdown',
            ...criarMenuVoltar()
        });
    } catch (error) {
        await ctx.replyWithMarkdown(`
üë§ *SUAS INFORMA√á√ïES DO TELEGRAM* üë§
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *ID do Usu√°rio:* \`${userId}\`
‚îÇ *Username:* ${userName}
‚îÇ *Primeiro Nome:* ${firstName}
‚îÇ *Sobrenome:* ${lastName}
‚îÇ *√â um Bot?* ${isBot}
‚îÇ *Idioma:* ${languageCode}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(Use /menu para navegar e ver o painel completo)
        `, criarMenuVoltar());
    }
    await ctx.answerCbQuery();
});

bot.action('creditos', async (ctx) => {
    try {
        await ctx.editMessageText(`
üåü *CR√âDITOS* üåü

Este bot foi criado e desenvolvido com carinho por:

ü§ñ *J074*

Agrade√ßo o uso e espero que seja muito √∫til! üòä

_Sugest√µes, melhorias ou d√∫vidas? Entre em contato!_
        `, {
            parse_mode: 'Markdown',
            ...criarMenuVoltar()
        });
    } catch (error) {
        await ctx.replyWithMarkdown(`
üåü *CR√âDITOS* üåü
Criado por: *J074*
(Use /menu para navegar e ver o painel completo)
        `, criarMenuVoltar());
    }
    await ctx.answerCbQuery();
});


// ====== CONSULTA DE IP ====== //
bot.command('ip', async (ctx) => {
    const ip = ctx.message.text.split(' ')[1] || '';

    try {
        const { data } = await axios.get(`http://ip-api.com/json/${ip}?fields=66846719`, {
            httpsAgent: agent
        });

        if (data.status === 'fail') throw new Error(data.message);

        await ctx.replyWithMarkdown(`
üåê *CONSULTA IP* üåê
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *IP:* \`${data.query}\`
‚îÇ *Pa√≠s:* ${data.country} (${data.countryCode})
‚îÇ *Cidade:* ${data.city}, ${data.regionName}
‚îÇ *Provedor:* ${data.isp}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, criarMenuVoltar());
    } catch (err) {
        await ctx.reply('‚ùå IP inv√°lido ou servi√ßo indispon√≠vel. Verifique o IP e tente novamente.', criarMenuVoltar());
    }
});

// ====== CONSULTA DE CPF ====== //
bot.command('cpf', async (ctx) => {
    const cpf = ctx.message.text.split(' ')[1];

    if (!cpf || !/^\d{11}$/.test(cpf)) {
        return ctx.reply('‚ö†Ô∏è Por favor, forne√ßa um CPF v√°lido (apenas n√∫meros, 11 d√≠gitos).', criarMenuVoltar());
    }

    const API_TOKEN = '1090'; // Use seu token de API real aqui
    const apiUrl = `https://searchapi.dnnl.live/consulta?token_api=${API_TOKEN}&cpf=${cpf}`;

    try {
        const { data } = await axios.get(apiUrl, {
            httpsAgent: agent // For√ßando o agente SOCKS para a requisi√ß√£o
        });

        // A API retornou status 200 no cURL, mas vamos verificar se o campo 'status' existe e √© 200
        if (data.status !== 200) { // Agora espera o n√∫mero 200
            // Se a API retornar um erro no campo 'message', exiba-o
            return ctx.reply(`‚ùå Erro na consulta de CPF: ${data.message || 'Status de erro da API: ' + data.status}`, criarMenuVoltar());
        }

        // Verifica se 'dados' existe e tem pelo menos um elemento
        if (!data.dados || data.dados.length === 0) {
            return ctx.reply('‚ùå Dados de CPF n√£o encontrados para este n√∫mero na base da API.', criarMenuVoltar());
        }

        const cpfData = data.dados[0]; // Acessa o primeiro (e √∫nico) objeto dentro do array 'dados'

        // Extraindo dados dos campos do objeto cpfData. ATEN√á√ÉO AOS NOMES DOS CAMPOS (MAI√öSCULOS)
        const nome = cpfData.NOME || 'N√£o dispon√≠vel';
        const genero = cpfData.SEXO || 'N√£o dispon√≠vel'; // A API retorna SEXO
        const nascimento = cpfData.NASC || 'N√£o dispon√≠vel'; // A API retorna NASC
        const renda = cpfData.RENDA || 'N√£o dispon√≠vel';
        const nomeMae = cpfData.NOME_MAE || 'N√£o dispon√≠vel'; // A API retorna NOME_MAE

        await ctx.replyWithMarkdown(`
üë§ *CONSULTA CPF* üë§
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *CPF:* \`${cpfData.CPF || 'N√£o dispon√≠vel'}\`
‚îÇ *Nome:* ${nome}
‚îÇ *G√™nero:* ${genero}
‚îÇ *Nascimento:* ${nascimento}
‚îÇ *Renda:* ${renda}
‚îÇ *Nome da M√£e:* ${nomeMae}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, criarMenuVoltar());

    } catch (err) {
        console.error('Erro na consulta de CPF:', err);
        // Mais mensagens de erro espec√≠ficas para depura√ß√£o
        if (axios.isAxiosError(err) && err.response) {
            if (err.response.status === 401) {
                await ctx.reply('‚ùå Erro de autentica√ß√£o na API de CPF. Verifique seu token.', criarMenuVoltar());
            } else if (err.response.status === 404) {
                await ctx.reply('‚ùå CPF n√£o encontrado nesta base de dados ou URL incorreta.', criarMenuVoltar());
            } else if (err.response.status === 429) {
                await ctx.reply('‚ùå Limite de requisi√ß√µes excedido na API de CPF. Tente novamente mais tarde.', criarMenuVoltar());
            } else {
                await ctx.reply(`‚ùå Erro HTTP ${err.response.status} ao consultar CPF. Detalhes: ${err.response.data ? JSON.stringify(err.response.data) : 'N/A'}`, criarMenuVoltar());
            }
        } else if (axios.isAxiosError(err) && err.code) {
            if (err.code === 'ECONNABORTED' || err.code === 'ETIMEDOUT') {
                await ctx.reply('‚ùå A requisi√ß√£o para a API de CPF demorou muito e foi cancelada. Pode ser problema de rede ou da API.', criarMenuVoltar());
            } else if (err.code === 'ECONNREFUSED') {
                await ctx.reply('‚ùå Conex√£o recusada ao proxy Tor. Verifique se o Tor est√° rodando.', criarMenuVoltar());
            }
            else {
                await ctx.reply('‚ùå Erro de conex√£o com a API de CPF. Verifique sua rede e o Tor.', criarMenuVoltar());
            }
        } else {
            await ctx.reply('‚ùå Erro inesperado ao consultar CPF. Verifique o console para mais detalhes.', criarMenuVoltar());
        }
    }
});


// ====== CONSULTA DE CEP ====== //
bot.command('cep', async (ctx) => {
    const cep = ctx.message.text.split(' ')[1];

    if (!cep || !/^\d{8}$/.test(cep)) {
        return ctx.reply('‚ö†Ô∏è Por favor, forne√ßa um CEP v√°lido (apenas n√∫meros, 8 d√≠gitos).', criarMenuVoltar());
    }

    try {
        const { data } = await axios.get(`https://viacep.com.br/ws/${cep}/json/`, {
            httpsAgent: agent // For√ßando o agente SOCKS para a requisi√ß√£o
        });

        if (data.erro) {
            return ctx.reply('‚ùå CEP n√£o encontrado ou inv√°lido. Verifique o n√∫mero e tente novamente.', criarMenuVoltar());
        }

        await ctx.replyWithMarkdown(`
üè† *CONSULTA CEP* üè†
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *CEP:* \`${data.cep}\`
‚îÇ *Logradouro:* ${data.logradouro}
‚îÇ *Bairro:* ${data.bairro}
‚îÇ *Cidade:* ${data.localidade}
‚îÇ *Estado:* ${data.uf}
‚îÇ *DDD:* ${data.ddd}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, criarMenuVoltar());

    } catch (err) {
        console.error('Erro na consulta de CEP:', err);
        await ctx.reply('‚ùå Erro ao consultar CEP. Tente novamente mais tarde.', criarMenuVoltar());
    }
});

// ====== CONSULTA DE DDD ====== //
bot.command('ddd', async (ctx) => {
    const ddd = ctx.message.text.split(' ')[1];

    if (!ddd || !/^\d{2}$/.test(ddd)) {
        return ctx.reply('‚ö†Ô∏è Por favor, forne√ßa um DDD v√°lido (apenas n√∫meros, 2 d√≠gitos).', criarMenuVoltar());
    }

    try {
        const { data } = await axios.get(`https://brasilapi.com.br/api/ddd/v1/${ddd}`, {
            httpsAgent: agent
        });

        if (!data || data.cities.length === 0) {
            return ctx.reply('‚ùå DDD n√£o encontrado ou inv√°lido. Verifique o n√∫mero e tente novamente.', criarMenuVoltar());
        }

        const cities = data.cities.slice(0, 10).join(', ') + (data.cities.length > 10 ? '...' : '');

        await ctx.replyWithMarkdown(`
‚òéÔ∏è *CONSULTA DDD* ‚òéÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *DDD:* \`${ddd}\`
‚îÇ *Estado(s):* ${data.state}
‚îÇ *Cidades (Exemplos):* ${cities}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, criarMenuVoltar());

    } catch (err) {
        console.error('Erro na consulta de DDD:', err);
        await ctx.reply('‚ùå Erro ao consultar DDD. Tente novamente mais tarde.', criarMenuVoltar());
    }
});

// ====== CONSULTA DE BIN ====== //
bot.command('bin', async (ctx) => {
    const bin = ctx.message.text.split(' ')[1];

    if (!bin || !/^\d{6}$/.test(bin)) {
        return ctx.reply('‚ö†Ô∏è Por favor, forne√ßa um BIN v√°lido (os primeiros 6 d√≠gitos do cart√£o).', criarMenuVoltar());
    }

    try {
        const { data } = await axios.get(`https://lookup.binlist.net/${bin}`, {
            httpsAgent: agent // For√ßando o agente SOCKS para a requisi√ß√£o
        });

        if (!data || !data.scheme) {
            return ctx.reply('‚ùå BIN n√£o encontrado ou inv√°lido. Verifique o n√∫mero e tente novamente.', criarMenuVoltar());
        }

        await ctx.replyWithMarkdown(`
üí≥ *CONSULTA BIN* üí≥
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ *BIN:* \`${bin}\`
‚îÇ *Bandeira:* ${data.scheme || 'N/A'}
‚îÇ *Tipo:* ${data.type || 'N/A'}
‚îÇ *Marca:* ${data.brand || 'N/A'}
‚îÇ *Pa√≠s:* ${data.country ? `${data.country.name} (${data.country.alpha2})` : 'N/A'}
‚îÇ *Banco:* ${data.bank ? `${data.bank.name} (${data.bank.url})` : 'N/A'}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        `, criarMenuVoltar());

    } catch (err) {
        console.error('Erro na consulta de BIN:', err);
        await ctx.reply('‚ùå Erro ao consultar BIN. Tente novamente mais tarde.', criarMenuVoltar());
    }
});

// ====== INICIALIZA√á√ÉO ====== //
bot.launch()
    .then(() => console.log('ü§ñ Bot online com menu funcional!'))
    .catch(err => console.error('üí• Erro:', err));

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));